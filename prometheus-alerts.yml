# ===========================================================================
# Prometheus Alerting Rules — CloudApp Platform
#
# Basic actionable alerts for service health, error rate, latency,
# and JVM heap usage.  Alerts show in Prometheus UI (/alerts).
# Alertmanager + notification routing is a follow-up.
# ===========================================================================
groups:
  - name: service_health
    rules:
      # -----------------------------------------------------------------------
      # Service Down — any scrape target is unreachable for > 1 minute
      # -----------------------------------------------------------------------
      - alert: ServiceDown
        expr: up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "{{ $labels.job }} is down"
          description: "Prometheus cannot scrape {{ $labels.job }} ({{ $labels.instance }}) for more than 1 minute."

      # -----------------------------------------------------------------------
      # High Error Rate — >5% of requests return 5xx over a 5-minute window
      # -----------------------------------------------------------------------
      - alert: HighErrorRate
        expr: |
          (
            sum(rate(http_server_requests_seconds_count{status=~"5.."}[5m])) by (job)
            /
            sum(rate(http_server_requests_seconds_count[5m])) by (job)
          ) > 0.05
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: ">5% error rate on {{ $labels.job }}"
          description: "{{ $labels.job }} is returning 5xx responses for more than 5% of requests over the last 5 minutes."

      # -----------------------------------------------------------------------
      # High Latency — P95 latency exceeds 2 seconds for > 5 minutes
      # -----------------------------------------------------------------------
      - alert: HighLatencyP95
        expr: histogram_quantile(0.95, sum(rate(http_server_requests_seconds_bucket[5m])) by (le, job)) > 2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "P95 latency >2s on {{ $labels.job }}"
          description: "The 95th percentile response time for {{ $labels.job }} has exceeded 2 seconds for more than 5 minutes."

      # -----------------------------------------------------------------------
      # JVM Heap High — heap usage >85% for > 5 minutes
      # -----------------------------------------------------------------------
      - alert: JvmHeapHigh
        expr: (jvm_memory_used_bytes{area="heap"} / jvm_memory_max_bytes{area="heap"}) > 0.85
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "JVM heap >85% on {{ $labels.job }}"
          description: "{{ $labels.job }} ({{ $labels.instance }}) heap usage has been above 85% for 5 minutes — risk of OOM."

      # -----------------------------------------------------------------------
      # Prometheus Self — Target scrape failures
      # -----------------------------------------------------------------------
      - alert: PrometheusTargetMissing
        expr: up == 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Prometheus target {{ $labels.job }} missing for 5 minutes"
          description: "A Prometheus scrape target has been unreachable for more than 5 minutes."

# ===========================================================================
# .github/workflows/ci-tests.yml — Comprehensive CI Test Pipeline
#
# Runs all test layers on every push and PR:
#   1. Backend integration tests (Spring Boot + real DBs)
#   2. ML Pipeline tests (Flask/pytest + real Postgres)
#   3. NGINX gateway tests (JWT, CORS, routing)
#   4. Frontend unit tests (React Testing Library)
#   5. Playwright E2E tests (full stack)
#
# Usage:
#   Triggered automatically on push/PR to main/develop.
#   Can also be triggered manually via workflow_dispatch.
# ===========================================================================

name: CI — Comprehensive Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  COMPOSE_FILE: docker-compose.test.yml

jobs:
  # =========================================================================
  # JOB 1: Backend Integration Tests (Spring Boot)
  # =========================================================================
  backend-tests:
    name: "Backend — Spring Boot Integration"
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-backend-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-buildx-backend-

      - name: Run CloudApp integration tests
        run: |
          docker compose -f docker-compose.test.yml up --build --abort-on-container-exit \
            test-backend
        env:
          DOCKER_BUILDKIT: 1

      - name: Run Petstore integration tests
        if: always()
        run: |
          docker compose -f docker-compose.test.yml up --build --abort-on-container-exit \
            test-backend-petstore

      - name: Run Vehicles API integration tests
        if: always()
        run: |
          docker compose -f docker-compose.test.yml up --build --abort-on-container-exit \
            test-backend-vehicles

      - name: Run Web Proxy integration tests
        if: always()
        run: |
          docker compose -f docker-compose.test.yml up --build --abort-on-container-exit \
            test-backend-webproxy

      - name: Collect test reports
        if: always()
        run: |
          mkdir -p test-results/backend/cloudapp
          mkdir -p test-results/backend/petstore
          mkdir -p test-results/backend/vehicles-api
          mkdir -p test-results/backend/web-proxy
          docker compose -f docker-compose.test.yml cp \
            test-backend:/home/root/target/surefire-reports/ test-results/backend/cloudapp/ 2>/dev/null || true
          docker compose -f docker-compose.test.yml cp \
            test-backend-petstore:/home/root/target/surefire-reports/ test-results/backend/petstore/ 2>/dev/null || true
          docker compose -f docker-compose.test.yml cp \
            test-backend-vehicles:/home/root/target/surefire-reports/ test-results/backend/vehicles-api/ 2>/dev/null || true
          docker compose -f docker-compose.test.yml cp \
            test-backend-webproxy:/home/root/target/surefire-reports/ test-results/backend/web-proxy/ 2>/dev/null || true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-test-results
          path: test-results/backend/
          retention-days: 7

      - name: Cleanup
        if: always()
        run: docker compose -f docker-compose.test.yml down -v --remove-orphans

  # =========================================================================
  # JOB 2: ML Pipeline Tests (Flask/pytest)
  # =========================================================================
  ml-pipeline-tests:
    name: "ML Pipeline — pytest"
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run ML Pipeline tests
        run: |
          docker compose -f docker-compose.test.yml up --build --abort-on-container-exit \
            test-ml-pipeline

      - name: Cleanup
        if: always()
        run: docker compose -f docker-compose.test.yml down -v --remove-orphans

  # =========================================================================
  # JOB 3: NGINX Gateway Tests
  # =========================================================================
  nginx-gateway-tests:
    name: "NGINX — Gateway Integration"
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Start backend services
        run: |
          set -euo pipefail
          if ! docker compose -f docker-compose.test.yml up -d --wait --wait-timeout 360 \
            test-postgres test-postgres-ml test-mysql test-mongo \
            test-zookeeper test-kafka \
            test-cloudapp test-petstore test-vehicles test-jiraproxy test-mlops test-nginx; then
            docker compose -f docker-compose.test.yml ps || true
            docker compose -f docker-compose.test.yml logs --tail=300 \
              test-cloudapp test-petstore test-vehicles test-jiraproxy test-mlops \
              test-postgres test-postgres-ml test-mysql test-mongo test-kafka test-zookeeper test-nginx || true
            exit 1
          fi

      - name: Wait for services to be healthy
        run: |
          docker compose -f docker-compose.test.yml ps

      - name: Run NGINX gateway tests
        run: |
          docker compose -f docker-compose.test.yml up --build --abort-on-container-exit \
            test-nginx-gateway

      - name: Cleanup
        if: always()
        run: docker compose -f docker-compose.test.yml down -v --remove-orphans

  # =========================================================================
  # JOB 4: API Contract Governance Tests
  # =========================================================================
  api-contract-tests:
    name: "API Contracts — OpenAPI Drift + TS Clients"
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Start backend services
        run: |
          set -euo pipefail
          if ! docker compose -f docker-compose.test.yml up -d --wait --wait-timeout 360 \
            test-postgres test-mysql test-mongo \
            test-zookeeper test-kafka \
            test-cloudapp test-petstore test-vehicles; then
            docker compose -f docker-compose.test.yml ps || true
            docker compose -f docker-compose.test.yml logs --tail=300 \
              test-cloudapp test-petstore test-vehicles \
              test-postgres test-mysql test-mongo test-kafka test-zookeeper || true
            exit 1
          fi

      - name: Run API contract checks
        run: |
          docker compose -f docker-compose.test.yml up --build --abort-on-container-exit \
            test-api-contracts

      - name: Cleanup
        if: always()
        run: docker compose -f docker-compose.test.yml down -v --remove-orphans

  # =========================================================================
  # JOB 5: Frontend Unit Tests
  # =========================================================================
  frontend-unit-tests:
    name: "Frontend — React Unit Tests"
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run unit tests
        run: |
          docker compose -f docker-compose.test.yml up --build --abort-on-container-exit \
            test-frontend-unit

      - name: Upload coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: frontend/cloudapp-shell/coverage/
          retention-days: 7

      - name: Cleanup
        if: always()
        run: docker compose -f docker-compose.test.yml down -v --remove-orphans

  # =========================================================================
  # JOB 6: Playwright E2E Tests
  # =========================================================================
  e2e-tests:
    name: "E2E — Playwright"
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [backend-tests, ml-pipeline-tests]  # Run after backend tests pass

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Start full stack
        run: |
          set -euo pipefail
          if ! docker compose -f docker-compose.test.yml up -d --wait --wait-timeout 420 \
            test-postgres test-postgres-ml test-mysql test-mongo \
            test-zookeeper test-kafka \
            test-cloudapp test-petstore test-vehicles test-jiraproxy test-mlops \
            test-nginx test-shell; then
            docker compose -f docker-compose.test.yml ps || true
            docker compose -f docker-compose.test.yml logs --tail=300 \
              test-cloudapp test-petstore test-vehicles test-jiraproxy test-mlops \
              test-postgres test-postgres-ml test-mysql test-mongo test-kafka test-zookeeper \
              test-nginx test-shell || true
            exit 1
          fi

      - name: Wait for services
        run: |
          docker compose -f docker-compose.test.yml ps

      - name: Run Playwright E2E tests
        run: |
          docker compose -f docker-compose.test.yml up --build --abort-on-container-exit \
            test-e2e

      - name: Collect Playwright artifacts
        if: always()
        run: |
          mkdir -p playwright-artifacts
          cp -R playwright-report playwright-artifacts/playwright-report 2>/dev/null || true
          cp -R test-results playwright-artifacts/test-results 2>/dev/null || true

      - name: Upload Playwright artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-results
          path: playwright-artifacts/
          retention-days: 7

      - name: Cleanup
        if: always()
        run: docker compose -f docker-compose.test.yml down -v --remove-orphans

  # =========================================================================
  # SUMMARY — Report test status
  # =========================================================================
  test-summary:
    name: "Test Summary"
    runs-on: ubuntu-latest
    needs: [backend-tests, ml-pipeline-tests, nginx-gateway-tests, api-contract-tests, frontend-unit-tests, e2e-tests]
    if: always()

    steps:
      - name: Report status
        run: |
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Layer | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend (Spring Boot) | ${{ needs.backend-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ML Pipeline (pytest) | ${{ needs.ml-pipeline-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| NGINX Gateway | ${{ needs.nginx-gateway-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| API Contracts | ${{ needs.api-contract-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend Unit | ${{ needs.frontend-unit-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Playwright E2E | ${{ needs.e2e-tests.result }} |" >> $GITHUB_STEP_SUMMARY

# ===========================================================================
# .github/workflows/ci-tests.yml — Comprehensive CI Test Pipeline
#
# Runs all test layers on every push and PR:
#   1. Backend integration tests (Spring Boot + real DBs)
#   2. ML Pipeline tests (Flask/pytest + real Postgres)
#   3. NGINX gateway tests (JWT, CORS, routing)
#   4. Frontend unit tests (React Testing Library)
#   5. Frontend lockfile native package checks
#   6. Optional dependency vulnerability scans (npm audit + pip-audit)
#   7. Playwright E2E tests (full stack)
#   8. AI Orchestration tests (pytest — auth, config, http_client, approvals)
#   9. AI Monitor checks (TypeScript typecheck + ESLint + Vite build)
#
# Usage:
#   Triggered automatically on push/PR to main/develop.
#   Can also be triggered manually via workflow_dispatch.
# ===========================================================================

name: CI — Comprehensive Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  COMPOSE_FILE: docker-compose.test.yml

jobs:
  # =========================================================================
  # JOB 1: Backend Integration Tests (Spring Boot)
  # =========================================================================
  backend-tests:
    name: "Backend — Spring Boot Integration"
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-backend-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-buildx-backend-

      - name: Run CloudApp integration tests
        run: |
          docker compose -f docker-compose.test.yml up --build --abort-on-container-exit \
            test-backend
        env:
          DOCKER_BUILDKIT: 1

      - name: Run Petstore integration tests
        if: always()
        run: |
          docker compose -f docker-compose.test.yml up --build --abort-on-container-exit \
            test-backend-petstore

      - name: Run Vehicles API integration tests
        if: always()
        run: |
          docker compose -f docker-compose.test.yml up --build --abort-on-container-exit \
            test-backend-vehicles

      - name: Run Web Proxy integration tests
        if: always()
        run: |
          docker compose -f docker-compose.test.yml up --build --abort-on-container-exit \
            test-backend-webproxy

      - name: Collect test reports
        if: always()
        run: |
          mkdir -p test-results/backend/cloudapp
          mkdir -p test-results/backend/petstore
          mkdir -p test-results/backend/vehicles-api
          mkdir -p test-results/backend/web-proxy
          docker compose -f docker-compose.test.yml cp \
            test-backend:/home/root/target/surefire-reports/ test-results/backend/cloudapp/ 2>/dev/null || true
          docker compose -f docker-compose.test.yml cp \
            test-backend-petstore:/home/root/target/surefire-reports/ test-results/backend/petstore/ 2>/dev/null || true
          docker compose -f docker-compose.test.yml cp \
            test-backend-vehicles:/home/root/target/surefire-reports/ test-results/backend/vehicles-api/ 2>/dev/null || true
          docker compose -f docker-compose.test.yml cp \
            test-backend-webproxy:/home/root/target/surefire-reports/ test-results/backend/web-proxy/ 2>/dev/null || true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-test-results
          path: test-results/backend/
          retention-days: 7

      - name: Cleanup
        if: always()
        run: docker compose -f docker-compose.test.yml down -v --remove-orphans

  # =========================================================================
  # JOB 2: ML Pipeline Tests (Flask/pytest)
  # =========================================================================
  ml-pipeline-tests:
    name: "ML Pipeline — pytest"
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run ML Pipeline tests
        run: |
          docker compose -f docker-compose.test.yml up --build --abort-on-container-exit \
            test-ml-pipeline

      - name: Cleanup
        if: always()
        run: docker compose -f docker-compose.test.yml down -v --remove-orphans

  # =========================================================================
  # JOB 3: NGINX Gateway Tests
  # =========================================================================
  nginx-gateway-tests:
    name: "NGINX — Gateway Integration"
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Start backend services
        run: |
          set -euo pipefail
          if ! docker compose -f docker-compose.test.yml up -d --wait --wait-timeout 360 \
            test-postgres test-postgres-ml test-mysql test-mongo \
            test-zookeeper test-kafka \
            test-cloudapp test-petstore test-vehicles test-jiraproxy test-mlops test-nginx; then
            docker compose -f docker-compose.test.yml ps || true
            docker compose -f docker-compose.test.yml logs --tail=300 \
              test-cloudapp test-petstore test-vehicles test-jiraproxy test-mlops \
              test-postgres test-postgres-ml test-mysql test-mongo test-kafka test-zookeeper test-nginx || true
            exit 1
          fi

      - name: Wait for services to be healthy
        run: |
          docker compose -f docker-compose.test.yml ps

      - name: Run NGINX gateway tests
        run: |
          docker compose -f docker-compose.test.yml up --build --abort-on-container-exit \
            test-nginx-gateway

      - name: Cleanup
        if: always()
        run: docker compose -f docker-compose.test.yml down -v --remove-orphans

  # =========================================================================
  # JOB 4: API Contract Governance Tests
  # =========================================================================
  api-contract-tests:
    name: "API Contracts — OpenAPI Drift + TS Clients"
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Start backend services
        run: |
          set -euo pipefail
          if ! docker compose -f docker-compose.test.yml up -d --wait --wait-timeout 360 \
            test-postgres test-mysql test-mongo \
            test-zookeeper test-kafka \
            test-cloudapp test-petstore test-vehicles; then
            docker compose -f docker-compose.test.yml ps || true
            docker compose -f docker-compose.test.yml logs --tail=300 \
              test-cloudapp test-petstore test-vehicles \
              test-postgres test-mysql test-mongo test-kafka test-zookeeper || true
            exit 1
          fi

      - name: Run API contract checks
        run: |
          docker compose -f docker-compose.test.yml up --build --abort-on-container-exit \
            test-api-contracts

      - name: Cleanup
        if: always()
        run: docker compose -f docker-compose.test.yml down -v --remove-orphans

  # =========================================================================
  # JOB 5: Frontend Unit Tests
  # =========================================================================
  frontend-unit-tests:
    name: "Frontend — React Unit Tests"
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run unit tests
        run: |
          docker compose -f docker-compose.test.yml up --build --abort-on-container-exit \
            test-frontend-unit

      - name: Upload coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: frontend/cloudapp-shell/coverage/
          retention-days: 7

      - name: Cleanup
        if: always()
        run: docker compose -f docker-compose.test.yml down -v --remove-orphans

  # =========================================================================
  # JOB 6: Frontend Lockfile Native Package Checks
  # =========================================================================
  frontend-lockfile-checks:
    name: "Frontend Lockfiles — Linux Native Packages"
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate frontend lockfiles
        run: python3 scripts/check_frontend_native_lockfiles.py

  # =========================================================================
  # JOB 7: Optional Dependency Scans (non-blocking for findings)
  # =========================================================================
  dependency-scans:
    name: "Dependency Security — Audit"
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      npm_status: ${{ steps.npm-audit.outputs.status }}
      python_status: ${{ steps.pip-audit.outputs.status }}
      maven_status: ${{ steps.maven-audit.outputs.status }}
      summary: ${{ steps.audit-summary.outputs.summary }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Audit npm production dependencies
        id: npm-audit
        run: |
          mkdir -p audit-reports
          status=clean

          for dir in frontend/cloudapp-shell ai-orchestration/ai-orchestration-monitor; do
            name="$(basename "$dir")"
            report="audit-reports/${name}-npm-audit.json"
            if ! npm audit \
              --package-lock-only \
              --omit=dev \
              --audit-level=high \
              --json \
              --prefix "$dir" > "$report"; then
              status=issues-found
            fi
          done

          echo "status=$status" >> "$GITHUB_OUTPUT"

      - name: Install pip-audit
        run: python3 -m pip install --upgrade pip pip-audit

      - name: Audit Python production dependencies
        id: pip-audit
        run: |
          mkdir -p audit-reports
          status=clean

          for req in backend/ml-pipeline/requirements.txt ai-orchestration/ai-orchestration-layer/requirements.txt; do
            name="$(basename "$(dirname "$req")")"
            report="audit-reports/${name}-pip-audit.json"
            if ! pip-audit \
              --requirement "$req" \
              --format json \
              --output "$report" \
              --progress-spinner off; then
              status=issues-found
            fi
          done

          echo "status=$status" >> "$GITHUB_OUTPUT"

      # Maven dependency scanning via OWASP Dependency-Check
      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: 21

      - name: Audit Maven dependencies (OWASP Dependency-Check)
        id: maven-audit
        run: |
          status=clean
          for dir in backend/cloudapp backend/petstore backend/vehicles-api backend/web-proxy; do
            name="$(basename "$dir")"
            report="audit-reports/${name}-owasp-report.json"
            if ! mvn -f "$dir/pom.xml" org.owasp:dependency-check-maven:check \
              -DfailBuildOnCVSS=7 \
              -Dformats=JSON \
              -Dodc.outputDirectory=audit-reports \
              --batch-mode --quiet 2>/dev/null; then
              status=issues-found
            fi
          done
          echo "status=$status" >> "$GITHUB_OUTPUT"

      - name: Upload dependency audit reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-audit-reports
          path: audit-reports/
          retention-days: 7

      - name: Summarize dependency scans
        id: audit-summary
        run: |
          if [ "${{ steps.npm-audit.outputs.status }}" = "clean" ] \
            && [ "${{ steps.pip-audit.outputs.status }}" = "clean" ] \
            && [ "${{ steps.maven-audit.outputs.status }}" = "clean" ]; then
            summary="clean"
          else
            summary="issues-found (non-blocking)"
          fi

          echo "summary=$summary" >> "$GITHUB_OUTPUT"

          echo "## Dependency Security Scan" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Ecosystem | Status |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-----------|--------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| npm | ${{ steps.npm-audit.outputs.status }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Python | ${{ steps.pip-audit.outputs.status }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Maven | ${{ steps.maven-audit.outputs.status }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "Reports are uploaded as the \`dependency-audit-reports\` artifact." >> "$GITHUB_STEP_SUMMARY"

  # =========================================================================
  # JOB 8: AI Orchestration Layer Tests (pytest)
  # =========================================================================
  ai-orchestration-tests:
    name: "AI Orchestration — pytest"
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run AI orchestration layer tests
        run: |
          docker compose -f docker-compose.test.yml up --build --abort-on-container-exit \
            test-ai-orchestration-layer

      - name: Cleanup
        if: always()
        run: docker compose -f docker-compose.test.yml down -v --remove-orphans

  # =========================================================================
  # JOB 9: AI Monitor Checks (ESLint + Vite Build)
  # =========================================================================
  ai-monitor-checks:
    name: "AI Monitor — Lint + Build"
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run AI monitor checks
        run: |
          docker compose -f docker-compose.test.yml up --build --abort-on-container-exit \
            test-ai-monitor-lint

      - name: Cleanup
        if: always()
        run: docker compose -f docker-compose.test.yml down -v --remove-orphans

  # =========================================================================
  # JOB 10: Playwright E2E Tests
  # =========================================================================
  e2e-tests:
    name: "E2E — Playwright"
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [backend-tests, ml-pipeline-tests]  # Run after backend tests pass

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Start full stack
        run: |
          set -euo pipefail
          if ! docker compose -f docker-compose.test.yml up -d --wait --wait-timeout 420 \
            test-postgres test-postgres-ml test-mysql test-mongo \
            test-zookeeper test-kafka \
            test-cloudapp test-petstore test-vehicles test-jiraproxy test-mlops \
            test-nginx test-shell; then
            docker compose -f docker-compose.test.yml ps || true
            docker compose -f docker-compose.test.yml logs --tail=300 \
              test-cloudapp test-petstore test-vehicles test-jiraproxy test-mlops \
              test-postgres test-postgres-ml test-mysql test-mongo test-kafka test-zookeeper \
              test-nginx test-shell || true
            exit 1
          fi

      - name: Wait for services
        run: |
          docker compose -f docker-compose.test.yml ps

      - name: Run Playwright E2E tests
        run: |
          docker compose -f docker-compose.test.yml up --build --abort-on-container-exit \
            test-e2e

      - name: Collect Playwright artifacts
        if: always()
        run: |
          mkdir -p playwright-artifacts
          cp -R playwright-report playwright-artifacts/playwright-report 2>/dev/null || true
          cp -R test-results playwright-artifacts/test-results 2>/dev/null || true

      - name: Upload Playwright artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-results
          path: playwright-artifacts/
          retention-days: 7

      - name: Cleanup
        if: always()
        run: docker compose -f docker-compose.test.yml down -v --remove-orphans

  # =========================================================================
  # SUMMARY — Report test status
  # =========================================================================
  test-summary:
    name: "Test Summary"
    runs-on: ubuntu-latest
    needs: [backend-tests, ml-pipeline-tests, nginx-gateway-tests, api-contract-tests, frontend-unit-tests, frontend-lockfile-checks, dependency-scans, ai-orchestration-tests, ai-monitor-checks, e2e-tests]
    if: always()

    steps:
      - name: Report status
        run: |
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Layer | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend (Spring Boot) | ${{ needs.backend-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ML Pipeline (pytest) | ${{ needs.ml-pipeline-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| NGINX Gateway | ${{ needs.nginx-gateway-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| API Contracts | ${{ needs.api-contract-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend Unit | ${{ needs.frontend-unit-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend Lockfiles | ${{ needs.frontend-lockfile-checks.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Scan (optional) | ${{ needs.dependency-scans.outputs.summary }} |" >> $GITHUB_STEP_SUMMARY
          echo "| AI Orchestration (pytest) | ${{ needs.ai-orchestration-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| AI Monitor (TS + Lint) | ${{ needs.ai-monitor-checks.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Playwright E2E | ${{ needs.e2e-tests.result }} |" >> $GITHUB_STEP_SUMMARY

services:
  # ===========================================================================
  # BACKEND SERVICES - Internal only (no ports exposed to host)
  #
  # FIX 4.1: Credentials externalized to .env; JWT_SECRET fail-fast (no fallback).
  # Compose limitation: depends_on cannot target services from another compose file.
  # Start infra first, then run this file separately:
  #   docker compose -f docker-compose-infrastructure.yml up -d
  #   docker compose -f docker-compose-app.yml up -d
  # FIX 4.9: Metrics exported to Prometheus via OTel agent + Actuator.
  # ===========================================================================
  jiraproxy:
    image: jiraproxy:latest
    container_name: jiraproxy
    build:
      context: ./
      dockerfile: Dockerfile_BE
      args:
        SERVICE_PATH: backend/web-proxy
    environment:
      - INTERNAL_SERVICE_TOKEN=${INTERNAL_SERVICE_TOKEN}
      - HEALTH_CHECK_URL=http://localhost:8501/jiraproxy/actuator/health
      - JIRA_DOMAIN=${JIRA_DOMAIN}
      - JIRA_EMAIL=${JIRA_EMAIL}
      - JIRA_API_TOKEN=${JIRA_API_TOKEN}
      # OpenTelemetry Java agent
      - JAVA_TOOL_OPTIONS=${OTEL_ENABLED:+-javaagent:/opt/opentelemetry-javaagent.jar}
      - OTEL_SERVICE_NAME=jiraproxy
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - OTEL_EXPORTER_OTLP_PROTOCOL=grpc
      - OTEL_TRACES_EXPORTER=otlp
      # FIX 4.9: Export metrics to Prometheus via OTel
      - OTEL_METRICS_EXPORTER=prometheus
      - OTEL_EXPORTER_PROMETHEUS_PORT=9464
      - OTEL_LOGS_EXPORTER=${OTEL_ENABLED:+otlp}
    networks:
      - backend
    restart: unless-stopped

  vehicles-api:
    image: vehicles-api:latest
    container_name: vehicles-api
    build:
      context: ./
      dockerfile: Dockerfile_BE
      args:
        SERVICE_PATH: backend/vehicles-api
    environment:
      - INTERNAL_SERVICE_TOKEN=${INTERNAL_SERVICE_TOKEN}
      - HEALTH_CHECK_URL=http://localhost:8880/vehicles/actuator/health
      # OpenTelemetry
      - JAVA_TOOL_OPTIONS=${OTEL_ENABLED:+-javaagent:/opt/opentelemetry-javaagent.jar}
      - OTEL_SERVICE_NAME=vehicles-api
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - OTEL_EXPORTER_OTLP_PROTOCOL=grpc
      - OTEL_TRACES_EXPORTER=otlp
      - OTEL_METRICS_EXPORTER=prometheus
      - OTEL_EXPORTER_PROMETHEUS_PORT=9464
      - OTEL_LOGS_EXPORTER=${OTEL_ENABLED:+otlp}
    networks:
      - backend
    restart: unless-stopped

  petstore:
    image: petstore:latest
    container_name: petstore
    build:
      context: ./
      dockerfile: Dockerfile_BE
      args:
        SERVICE_PATH: backend/petstore
    environment:
      - DOCKER_HOST_IP=host.docker.internal
      - INTERNAL_SERVICE_TOKEN=${INTERNAL_SERVICE_TOKEN}
      - HEALTH_CHECK_URL=http://localhost:8083/petstore/actuator/health
      # FIX 4.1: DB credentials from .env
      # Use internal Docker DNS instead of host.docker.internal (not reliable in Linux CI).
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/petstore?serverTimezone=UTC
      - SPRING_DATASOURCE_USERNAME=${MYSQL_ROOT_USERNAME:?Set MYSQL_ROOT_USERNAME in .env}
      - SPRING_DATASOURCE_PASSWORD=${MYSQL_ROOT_PASSWORD:?Set MYSQL_ROOT_PASSWORD in .env}
      # OpenTelemetry
      - JAVA_TOOL_OPTIONS=${OTEL_ENABLED:+-javaagent:/opt/opentelemetry-javaagent.jar}
      - OTEL_SERVICE_NAME=petstore
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - OTEL_EXPORTER_OTLP_PROTOCOL=grpc
      - OTEL_TRACES_EXPORTER=otlp
      - OTEL_METRICS_EXPORTER=prometheus
      - OTEL_EXPORTER_PROMETHEUS_PORT=9464
      - OTEL_LOGS_EXPORTER=${OTEL_ENABLED:+otlp}
    networks:
      - backend
    restart: unless-stopped

  cloudapp:
    image: cloudapp:latest
    container_name: cloudapp
    build:
      context: ./
      dockerfile: Dockerfile_BE
      args:
        SERVICE_PATH: backend/cloudapp
    environment:
      - DOCKER_HOST_IP=host.docker.internal
      - DOCKER_HOST_KAFKA_PORT=9092
      - INTERNAL_SERVICE_TOKEN=${INTERNAL_SERVICE_TOKEN}
      # FIX 4.1: JWT_SECRET with no fallback â€” fails fast if missing
      - JWT_SECRET=${JWT_SECRET:?Set JWT_SECRET in .env}
      - JWT_EXPIRATION_MS=${JWT_EXPIRATION_MS}
      - JWT_PRIVATE_KEY_PATH=/run/secrets/jwt-private-key.pem
      - JWT_PUBLIC_KEY_PATH=/run/secrets/jwt-public-key.pub
      # Demo users (dev-only seed on startup)
      - CLOUDAPP_SEED_DEMO_USERS_ENABLED=true
      - CLOUDAPP_SEED_DEMO_USERS_ADMIN_USERNAME=cloudadmin
      - CLOUDAPP_SEED_DEMO_USERS_ADMIN_PASSWORD=cloudy
      - CLOUDAPP_SEED_DEMO_USERS_REGULAR_USERNAME=regularuser123
      - CLOUDAPP_SEED_DEMO_USERS_REGULAR_PASSWORD=456789
      # FIX 4.1: DB credentials from .env
      # Use internal Docker DNS for CI/Linux compatibility across split compose stacks.
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/${POSTGRES_DB:?Set POSTGRES_DB in .env}
      - SPRING_KAFKA_PRODUCER_BOOTSTRAP_SERVERS=broker:29092
      - SPRING_KAFKA_CONSUMER_BOOTSTRAP_SERVERS=broker:29092
      - SPRING_DATASOURCE_USERNAME=${POSTGRES_USER:?Set POSTGRES_USER in .env}
      - SPRING_DATASOURCE_PASSWORD=${POSTGRES_PASSWORD:?Set POSTGRES_PASSWORD in .env}
      - SPRING_DATA_MONGODB_URI=mongodb://${MONGO_USER}:${MONGO_PASSWORD}@mongo:27017/${MONGO_DB}?authSource=admin&maxPoolSize=${MONGO_MAX_POOL_SIZE:-50}&minPoolSize=${MONGO_MIN_POOL_SIZE:-10}&serverSelectionTimeoutMS=5000
      - HEALTH_CHECK_URL=http://localhost:8099/cloudapp/actuator/health
      # OpenTelemetry
      - JAVA_TOOL_OPTIONS=${OTEL_ENABLED:+-javaagent:/opt/opentelemetry-javaagent.jar}
      - OTEL_SERVICE_NAME=cloudapp
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - OTEL_EXPORTER_OTLP_PROTOCOL=grpc
      - OTEL_TRACES_EXPORTER=otlp
      - OTEL_METRICS_EXPORTER=prometheus
      - OTEL_EXPORTER_PROMETHEUS_PORT=9464
      - OTEL_LOGS_EXPORTER=${OTEL_ENABLED:+otlp}
    networks:
      - backend
    volumes:
      - ${JWT_PRIVATE_KEY_FILE:?Set JWT_PRIVATE_KEY_FILE in .env}:/run/secrets/jwt-private-key.pem:ro
      - ${JWT_PUBLIC_KEY_FILE:?Set JWT_PUBLIC_KEY_FILE in .env}:/run/secrets/jwt-public-key.pub:ro
    restart: unless-stopped

  mlops-segmentation:
    build:
      context: ./
      dockerfile: Dockerfile_PY
      args:
        SERVICE_PATH: backend/ml-pipeline
        SERVICE_PORT: 8600
    container_name: mlops-segmentation
    environment:
      - DOCKER_HOST_IP=host.docker.internal
      # FIX 4.1: DB credentials from .env
      - ML_DB_USER=${POSTGRES_ML_USER}
      - ML_DB_PASSWORD=${POSTGRES_ML_PASSWORD}
      - ML_DB_HOST=postgres-ml
      - ML_DB_PORT=5432
      - ML_DB_NAME=${POSTGRES_ML_DB}
      # OpenTelemetry for Flask/Python
      - OTEL_ENABLED=${OTEL_ENABLED}
      - OTEL_SERVICE_NAME=ml-pipeline
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - OTEL_PYTHON_EXCLUDED_URLS=health
    networks:
      - backend
    restart: unless-stopped

  # ===========================================================================
  # NGINX GATEWAY - The ONLY entry point to backends
  # FIX 4.3: Now listens on both :80 (HTTP) and :443 (HTTPS).
  # ===========================================================================
  next-nginx-jwt:
    container_name: next-nginx-jwt
    ports:
      - "80:80"
      - "443:443"
    build:
      context: ./frontend/nginx
      dockerfile: Dockerfile
    environment:
      - INTERNAL_SERVICE_TOKEN=${INTERNAL_SERVICE_TOKEN}
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1/nginx_health || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - frontend
      - backend
    volumes:
      - ${JWT_PUBLIC_KEY_FILE:?Set JWT_PUBLIC_KEY_FILE in .env}:/etc/nginx/localhost+3-key.pub:ro
    depends_on:
      - cloudapp
      - petstore
      - jiraproxy
      - vehicles-api
      - mlops-segmentation
    restart: unless-stopped

  # ===========================================================================
  # FRONTEND SERVICES
  # ===========================================================================
  next-cloudapp-shell:
    build:
      context: ./
      dockerfile: Dockerfile_FE
      args:
        SERVICE_PATH: frontend/cloudapp-shell
        SERVICE_PORT: 5001
        NEXT_PRIVATE_LOCAL_WEBPACK: true
        NEXT_PUBLIC_REMOTE_OPENMAPS_URL: ${NEXT_PUBLIC_REMOTE_OPENMAPS_URL:-http://localhost:5002}
        NEXT_PUBLIC_REMOTE_JIRA_URL: ${NEXT_PUBLIC_REMOTE_JIRA_URL:-http://localhost:5003}
        NEXT_PUBLIC_REMOTE_CHATLLM_URL: ${NEXT_PUBLIC_REMOTE_CHATLLM_URL:-http://localhost:5333}
        NEXT_PUBLIC_REMOTE_MLOPS_URL: ${NEXT_PUBLIC_REMOTE_MLOPS_URL:-http://localhost:5005}
        NEXT_PUBLIC_REMOTE_PETSTORE_URL: ${NEXT_PUBLIC_REMOTE_PETSTORE_URL:-http://localhost:5006}
    container_name: next-cloudapp-shell
    ports:
      - 5001:5001
    environment:
      - DOCKER_HOST_IP=host.docker.internal
    networks:
      - frontend
    restart: unless-stopped

  next-openmaps:
    build:
      context: ./
      dockerfile: Dockerfile_FE
      args:
        SERVICE_PATH: frontend/remote/openmaps
        SERVICE_PORT: 5002
        NEXT_PRIVATE_LOCAL_WEBPACK: true
    container_name: next-openmaps
    ports:
      - 5002:5002
    environment:
      - DOCKER_HOST_IP=host.docker.internal
    networks:
      - frontend
    restart: unless-stopped

  next-jira:
    build:
      context: ./
      dockerfile: Dockerfile_FE
      args:
        SERVICE_PATH: frontend/remote/jira
        SERVICE_PORT: 5003
        NEXT_PRIVATE_LOCAL_WEBPACK: true
        NEXT_PUBLIC_LLM_MODEL: ${LLM_MODEL}
        NEXT_PUBLIC_JIRA_PROJECT_KEY: ${JIRA_PROJECT_KEY}
    container_name: next-jira
    ports:
      - 5003:5003
    environment:
      - DOCKER_HOST_IP=host.docker.internal
    networks:
      - frontend
    restart: unless-stopped

  next-mlops:
    build:
      context: ./
      dockerfile: Dockerfile_FE
      args:
        SERVICE_PATH: frontend/remote/mlops
        SERVICE_PORT: 5005
        NEXT_PRIVATE_LOCAL_WEBPACK: true
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:80}
    container_name: next-mlops
    ports:
      - 5005:5005
    environment:
      - DOCKER_HOST_IP=host.docker.internal
    networks:
      - frontend
    restart: unless-stopped

  next-petstore:
    build:
      context: ./
      dockerfile: Dockerfile_FE
      args:
        SERVICE_PATH: frontend/remote/petstore
        SERVICE_PORT: 5006
        NEXT_PRIVATE_LOCAL_WEBPACK: true
    container_name: next-petstore
    ports:
      - 5006:5006
    environment:
      - DOCKER_HOST_IP=host.docker.internal
    networks:
      - frontend
    restart: unless-stopped

  next-chatllm:
    build:
      context: ./
      dockerfile: Dockerfile_FE
      args:
        SERVICE_PATH: frontend/remote/chatllm
        SERVICE_PORT: 5333
        NEXT_PRIVATE_LOCAL_WEBPACK: true
        NEXT_PUBLIC_LLM_MODEL: ${LLM_MODEL}
    container_name: next-chatllm
    ports:
      - 5333:5333
    environment:
      - DOCKER_HOST_IP=host.docker.internal
      # CI/Linux: route server-side /api/chat to Ollama over the shared Docker network.
      - OLLAMA_URL=http://ollama:11434
    networks:
      - frontend
      - backend
    restart: unless-stopped

# ===========================================================================
# NETWORKS
# ===========================================================================
networks:
  frontend:
    name: app-frontend
  backend:
    name: app-backend

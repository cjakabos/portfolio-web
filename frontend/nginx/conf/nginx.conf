# FIX 4.2: Run as dedicated 'nginx' user instead of root.
# The Dockerfile creates this user and sets ownership of required dirs.
user  nginx;
worker_processes  1;

pid        /tmp/nginx.pid;

load_module /usr/lib64/nginx/modules/ngx_http_auth_jwt_module.so;

events {
    worker_connections  1024;
}

http {
    # FIX 4.2: Writable temp paths for non-root operation
    client_body_temp_path /tmp/client_body;
    proxy_temp_path       /tmp/proxy;
    fastcgi_temp_path     /tmp/fastcgi;
    uwsgi_temp_path       /tmp/uwsgi;
    scgi_temp_path        /tmp/scgi;

    # Direct logs to stdout and stderr
    error_log /dev/stderr debug;
    access_log /dev/stdout;

    auth_jwt_loginurl "http://localhost:5001/login";

    # =========================================================================
    # FILE UPLOAD SETTINGS - REQUIRED FOR RAG
    # =========================================================================
    client_max_body_size 20M;
    client_body_buffer_size 20M;
    client_body_timeout 120s;
    proxy_request_buffering off;

    # =========================================================================
    # DNS Resolver - Docker's internal DNS (enables failsafe startup)
    # =========================================================================
    resolver 127.0.0.11 valid=10s ipv6=off;
    resolver_timeout 5s;

    # =========================================================================
    # CORS Origin Mapping - Regex-based
    # =========================================================================
    map $http_origin $cors_origin {
        default "";
        "~^https?://(localhost|127\.0\.0\.1)(:\d+)?$" $http_origin;
    }

    # =========================================================================
    # Rate Limiting
    # =========================================================================
    limit_req_zone $binary_remote_addr zone=api_general:10m rate=30r/s;
    limit_req_zone $binary_remote_addr zone=auth_endpoints:10m rate=5r/s;
    limit_req_zone $binary_remote_addr zone=ai_endpoints:10m rate=10r/s;

    # =========================================================================
    # OpenTelemetry — Request ID correlation
    # =========================================================================
    map $http_x_request_id $request_id_value {
        default $http_x_request_id;
        ""      $request_id;
    }

    # =========================================================================
    # HTTP Server (port 80)
    #
    # FIX 4.3: In production, uncomment the redirect to force HTTPS.
    # =========================================================================
    server {
        listen 80;
        listen [::]:80;
        server_name localhost;
        server_tokens off;

        # Uncomment for production to redirect all HTTP → HTTPS:
        # return 301 https://$host$request_uri;

        # Health check endpoint (always on port 80 for Docker healthcheck)
        location /nginx_health {
            stub_status on;
            access_log off;
            allow 127.0.0.0/8;
            allow 172.16.0.0/12;
            allow 10.0.0.0/8;
            deny all;
        }

        # All application routes (shared with HTTPS server)
        include /etc/nginx/locations.conf;
    }

    # =========================================================================
    # FIX 4.3: HTTPS Server (port 443) — TLS Termination
    #
    # Uses mkcert-generated certs for local dev (localhost+3.pem).
    # For production: replace with Let's Encrypt / ACM certs.
    # =========================================================================
    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        server_name localhost;
        server_tokens off;

        ssl_certificate     /etc/nginx/ssl/localhost+3.pem;
        ssl_certificate_key /etc/nginx/ssl/localhost+3-key.pem;

        # Modern TLS configuration (Mozilla Intermediate)
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
        ssl_prefer_server_ciphers off;
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 1d;

        # HSTS — uncomment for production
        # add_header Strict-Transport-Security "max-age=63072000" always;

        # Health check on HTTPS too
        location /nginx_health {
            stub_status on;
            access_log off;
            allow 127.0.0.0/8;
            allow 172.16.0.0/12;
            allow 10.0.0.0/8;
            deny all;
        }

        # All application routes (same as HTTP)
        include /etc/nginx/locations.conf;
    }
}

# ===========================================================================
# locations.conf — Shared location blocks (included by both HTTP and HTTPS)
#
# CORS headers are managed via reusable snippets in /etc/nginx/cors/.
# Security headers are added via /etc/nginx/security-headers.conf.
# ===========================================================================

# =====================================================================
# Default Location - Static Files
# =====================================================================
location / {
  root    /usr/share/nginx/html;
  index   index.html;
  try_files $uri $uri/ /index.html;
}

# =================================================================
# API VERSIONING
# =================================================================
location ~ ^/v1/(cloudapp-admin|cloudapp|petstore|vehicles|jiraproxy|mlops-segmentation|ai)(/.*)?$ {
    rewrite ^/v1/(.*)$ /$1 last;
}

# =====================================================================
# AI Orchestration Layer - Health Endpoint
# =====================================================================
location = /ai/health {
    limit_req zone=api_general burst=5 nodelay;

    include /etc/nginx/cors/cors-hide-upstream.conf;
    include /etc/nginx/cors/cors-response-health.conf;
    include /etc/nginx/security-headers.conf;

    set $ai_backend "http://ai-orchestration-layer:8700";
    rewrite ^/ai/(.*) /$1 break;
    proxy_pass $ai_backend;

    proxy_set_header traceparent $http_traceparent;
    proxy_set_header tracestate $http_tracestate;
    proxy_set_header X-Request-ID $request_id_value;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_redirect off;
}

# =====================================================================
# AI Orchestration Layer - RAG Upload Endpoint (SPECIFIC)
# Must be before the general /ai/ location
# =====================================================================
location /ai/rag/documents/upload {
    limit_req zone=ai_endpoints burst=30 nodelay;
    auth_request /_auth/cloudapp/header-or-cookie;
    auth_request_set $auth_user $upstream_http_x_auth_user;
    auth_request_set $auth_roles $upstream_http_x_auth_roles;
    error_page 401 = @cors_unauthorized;

    include /etc/nginx/cors/cors-preflight-full.conf;
    include /etc/nginx/cors/cors-hide-upstream.conf;
    include /etc/nginx/cors/cors-response-full-expose.conf;
    include /etc/nginx/security-headers.conf;

    client_max_body_size 20M;
    client_body_buffer_size 20M;
    client_body_timeout 300s;
    proxy_read_timeout 300s;
    proxy_send_timeout 300s;

    set $ai_backend "http://ai-orchestration-layer:8700";
    rewrite ^/ai/(.*) /$1 break;
    proxy_pass $ai_backend;

    proxy_set_header Authorization $http_authorization;
    proxy_set_header X-Auth-User $auth_user;
    proxy_set_header X-Auth-Roles $auth_roles;
    proxy_set_header X-Internal-Auth "";
    proxy_set_header traceparent $http_traceparent;
    proxy_set_header tracestate $http_tracestate;
    proxy_set_header X-Request-ID $request_id_value;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_http_version 1.1;
    proxy_set_header Connection "";
}

# =====================================================================
# AI Orchestration Layer — Admin/System Endpoints (H1)
# Requires ROLE_ADMIN. Longest-prefix match ensures this wins over /ai/.
# Covers: feature-status, circuit-breakers, connection-stats, errors
# =====================================================================
location /ai/system/ {
    limit_req zone=ai_endpoints burst=20 nodelay;
    auth_request /_auth/cloudapp/admin-only;
    auth_request_set $auth_user $upstream_http_x_auth_user;
    auth_request_set $auth_roles $upstream_http_x_auth_roles;
    error_page 401 = @cors_unauthorized;
    error_page 403 = @cors_forbidden;

    include /etc/nginx/cors/cors-preflight-full.conf;
    include /etc/nginx/cors/cors-hide-upstream.conf;
    include /etc/nginx/cors/cors-response-full.conf;
    include /etc/nginx/security-headers.conf;

    set $ai_backend "http://ai-orchestration-layer:8700";
    rewrite ^/ai/(.*) /$1 break;
    proxy_pass $ai_backend;

    proxy_set_header Authorization $http_authorization;
    proxy_set_header X-Auth-User $auth_user;
    proxy_set_header X-Auth-Roles $auth_roles;
    proxy_set_header X-Internal-Auth "";
    proxy_set_header traceparent $http_traceparent;
    proxy_set_header tracestate $http_tracestate;
    proxy_set_header X-Request-ID $request_id_value;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# =====================================================================
# AI Orchestration Layer Routes (user-level auth required)
# =====================================================================
location /ai/ {
    limit_req zone=ai_endpoints burst=120 nodelay;
    auth_request /_auth/cloudapp/header-or-cookie;
    auth_request_set $auth_user $upstream_http_x_auth_user;
    auth_request_set $auth_roles $upstream_http_x_auth_roles;
    error_page 401 = @cors_unauthorized;

    include /etc/nginx/cors/cors-preflight-full.conf;
    include /etc/nginx/cors/cors-hide-upstream.conf;
    include /etc/nginx/cors/cors-response-full.conf;
    include /etc/nginx/security-headers.conf;

    set $ai_backend "http://ai-orchestration-layer:8700";
    rewrite ^/ai/(.*) /$1 break;
    proxy_pass $ai_backend;

    proxy_set_header Authorization $http_authorization;
    proxy_set_header X-Auth-User $auth_user;
    proxy_set_header X-Auth-Roles $auth_roles;
    proxy_set_header X-Internal-Auth "";
    proxy_set_header traceparent $http_traceparent;
    proxy_set_header tracestate $http_tracestate;
    proxy_set_header X-Request-ID $request_id_value;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_read_timeout 86400;
}

# AI WebSocket endpoint (user-level auth required)
location /ai/ws/ {
    auth_request /_auth/cloudapp/header-or-cookie;
    auth_request_set $auth_user $upstream_http_x_auth_user;
    error_page 401 = @cors_unauthorized;

    include /etc/nginx/cors/cors-preflight-ws.conf;
    include /etc/nginx/cors/cors-hide-upstream.conf;
    include /etc/nginx/cors/cors-response-ws.conf;
    include /etc/nginx/security-headers.conf;

    set $ai_ws_backend "http://ai-orchestration-layer:8700";
    rewrite ^/ai/ws/(.*) /ws/$1 break;
    proxy_pass $ai_ws_backend;

    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Auth-User $auth_user;
    proxy_set_header X-Internal-Auth "";
    proxy_set_header traceparent $http_traceparent;
    proxy_set_header tracestate $http_tracestate;
    proxy_read_timeout 86400;
}

# =====================================================================
# CORS-aware 401 handler — used by auth_request locations so that
# expired-JWT rejections still carry CORS headers.  Without this the
# browser blocks the 401 response and the frontend only sees a
# "Network Error" instead of the 401 status code.
# =====================================================================
location @cors_unauthorized {
    internal;
    add_header 'Access-Control-Allow-Origin' $cors_origin always;
    add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
    add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, X-XSRF-TOKEN, X-Requested-With, traceparent, tracestate' always;
    add_header 'Access-Control-Allow-Credentials' 'true' always;
    include /etc/nginx/security-headers.conf;
    default_type application/json;
    return 401 '{"error":"Unauthorized"}';
}

# CORS-aware 403 handler — returned when a user is authenticated but lacks
# the required role (e.g. non-admin hitting an admin-only path).
location @cors_forbidden {
    internal;
    add_header 'Access-Control-Allow-Origin' $cors_origin always;
    add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
    add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, X-XSRF-TOKEN, X-Requested-With, traceparent, tracestate' always;
    add_header 'Access-Control-Allow-Credentials' 'true' always;
    include /etc/nginx/security-headers.conf;
    default_type application/json;
    return 403 '{"error":"Forbidden"}';
}

# =====================================================================
# CloudApp Routes
# =====================================================================

# Internal auth_request targets (replaces custom JWT C module validation)
location = /_auth/cloudapp/header-or-cookie {
    internal;

    # Allow service-to-service calls with internal token (e.g. AI orchestration)
    if ($http_x_internal_auth = "${INTERNAL_SERVICE_TOKEN}") {
        return 200;
    }

    proxy_pass_request_body off;
    proxy_set_header Content-Length "";
    proxy_method GET;

    proxy_set_header Authorization $http_authorization;
    proxy_set_header Cookie $http_cookie;
    proxy_set_header traceparent $http_traceparent;
    proxy_set_header tracestate $http_tracestate;
    proxy_set_header X-Request-ID $request_id_value;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_redirect off;

    proxy_pass http://cloudapp:8099/cloudapp/user/auth-check;
}

location = /_auth/cloudapp/header-only {
    internal;

    # Allow service-to-service calls with internal token (e.g. AI orchestration)
    if ($http_x_internal_auth = "${INTERNAL_SERVICE_TOKEN}") {
        return 200;
    }

    proxy_pass_request_body off;
    proxy_set_header Content-Length "";
    proxy_method GET;

    proxy_set_header Authorization $http_authorization;
    proxy_set_header Cookie "";
    proxy_set_header traceparent $http_traceparent;
    proxy_set_header tracestate $http_tracestate;
    proxy_set_header X-Request-ID $request_id_value;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_redirect off;

    proxy_pass http://cloudapp:8099/cloudapp/user/auth-check;
}

# Admin-only auth check. Validates JWT AND requires ROLE_ADMIN.
# Spring Security returns 401 for missing/invalid JWT, 403 for non-admin.
location = /_auth/cloudapp/admin-only {
    internal;

    proxy_pass_request_body off;
    proxy_set_header Content-Length "";
    proxy_method GET;

    proxy_set_header Authorization $http_authorization;
    proxy_set_header Cookie $http_cookie;
    proxy_set_header traceparent $http_traceparent;
    proxy_set_header tracestate $http_tracestate;
    proxy_set_header X-Request-ID $request_id_value;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_redirect off;

    proxy_pass http://cloudapp:8099/cloudapp/user/admin/auth-check;
}

# Admin monitor paths.
# Requires real admin identity at the gateway — the caller must present a
# valid JWT with ROLE_ADMIN. After auth the request is forwarded with the
# internal service token so CloudApp treats it as a trusted internal call.
location /cloudapp-admin/ {
    limit_req zone=api_general burst=20 nodelay;
    auth_request /_auth/cloudapp/admin-only;
    error_page 401 = @cors_unauthorized;
    error_page 403 = @cors_forbidden;

    include /etc/nginx/cors/cors-preflight-full.conf;
    include /etc/nginx/cors/cors-hide-upstream.conf;
    include /etc/nginx/cors/cors-response-full-expose.conf;
    include /etc/nginx/security-headers.conf;

    set $cloudapp_backend "http://cloudapp:8099";
    rewrite ^/cloudapp-admin/(.*)$ /cloudapp/$1 break;
    proxy_pass $cloudapp_backend;

    proxy_set_header X-Internal-Auth "${INTERNAL_SERVICE_TOKEN}";
    proxy_set_header Authorization "";
    proxy_set_header traceparent $http_traceparent;
    proxy_set_header tracestate $http_tracestate;
    proxy_set_header X-Request-ID $request_id_value;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_redirect off;
}

# Auth endpoints (register/login/logout) — no JWT required
location ~ ^/cloudapp/user/(user-register|user-login|user-logout) {
    limit_req zone=auth_endpoints burst=10 nodelay;

    include /etc/nginx/cors/cors-preflight-xsrf.conf;
    include /etc/nginx/cors/cors-hide-upstream.conf;
    include /etc/nginx/cors/cors-response-xsrf.conf;
    include /etc/nginx/security-headers.conf;

    set $cloudapp_backend "http://cloudapp:8099";
    proxy_pass $cloudapp_backend;

    proxy_set_header Authorization $http_authorization;
    proxy_set_header traceparent $http_traceparent;
    proxy_set_header tracestate $http_tracestate;
    proxy_set_header X-Request-ID $request_id_value;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# Public health endpoint (kept outside JWT enforcement for health checks/tests)
location = /cloudapp/actuator/health {
    limit_req zone=api_general burst=5 nodelay;

    include /etc/nginx/cors/cors-hide-upstream.conf;
    include /etc/nginx/cors/cors-response-health.conf;
    include /etc/nginx/security-headers.conf;

    set $cloudapp_backend "http://cloudapp:8099";
    proxy_pass $cloudapp_backend;

    proxy_set_header traceparent $http_traceparent;
    proxy_set_header tracestate $http_tracestate;
    proxy_set_header X-Request-ID $request_id_value;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_redirect off;
}

# WebSocket endpoint
location ~ ^/cloudapp/ws {
    auth_request /_auth/cloudapp/header-or-cookie;
    error_page 401 = @cors_unauthorized;

    include /etc/nginx/cors/cors-preflight-ws.conf;
    include /etc/nginx/cors/cors-hide-upstream.conf;
    include /etc/nginx/cors/cors-response-ws.conf;
    include /etc/nginx/security-headers.conf;

    set $cloudapp_ws_backend "http://cloudapp:8099";
    proxy_pass $cloudapp_ws_backend;

    proxy_set_header Authorization $http_authorization;
    proxy_set_header traceparent $http_traceparent;
    proxy_set_header tracestate $http_tracestate;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
}

# General cloudapp paths (JWT required)
location ~ ^/cloudapp/(?!.*(?:user-register|user-login|user-logout|ws)) {
    limit_req zone=api_general burst=20 nodelay;
    auth_request /_auth/cloudapp/header-or-cookie;
    error_page 401 = @cors_unauthorized;

    include /etc/nginx/cors/cors-preflight-xsrf.conf;
    include /etc/nginx/cors/cors-hide-upstream.conf;
    include /etc/nginx/cors/cors-response-xsrf.conf;
    include /etc/nginx/security-headers.conf;

    set $cloudapp_backend "http://cloudapp:8099";
    proxy_pass $cloudapp_backend;

    proxy_set_header Authorization $http_authorization;
    proxy_set_header traceparent $http_traceparent;
    proxy_set_header tracestate $http_tracestate;
    proxy_set_header X-Request-ID $request_id_value;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_redirect off;
}

# =====================================================================
# Petstore Routes
# =====================================================================
location = /petstore/actuator/health {
    limit_req zone=api_general burst=5 nodelay;

    include /etc/nginx/cors/cors-hide-upstream.conf;
    include /etc/nginx/cors/cors-response-health.conf;
    include /etc/nginx/security-headers.conf;

    set $petstore_backend "http://petstore:8083";
    proxy_pass $petstore_backend;

    proxy_set_header traceparent $http_traceparent;
    proxy_set_header tracestate $http_tracestate;
    proxy_set_header X-Request-ID $request_id_value;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_redirect off;
}

location /petstore {
    limit_req zone=api_general burst=20 nodelay;
    auth_request /_auth/cloudapp/header-or-cookie;
    error_page 401 = @cors_unauthorized;

    include /etc/nginx/cors/cors-preflight-full.conf;
    include /etc/nginx/cors/cors-hide-upstream.conf;
    include /etc/nginx/cors/cors-response-full.conf;
    include /etc/nginx/security-headers.conf;

    set $petstore_backend "http://petstore:8083";
    proxy_pass $petstore_backend;

    proxy_set_header traceparent $http_traceparent;
    proxy_set_header tracestate $http_tracestate;
    proxy_set_header X-Request-ID $request_id_value;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_redirect off;
}

# =====================================================================
# Vehicles Routes
# =====================================================================
location = /vehicles/actuator/health {
    limit_req zone=api_general burst=5 nodelay;

    include /etc/nginx/cors/cors-hide-upstream.conf;
    include /etc/nginx/cors/cors-response-health.conf;
    include /etc/nginx/security-headers.conf;

    set $vehicles_backend "http://vehicles-api:8880";
    proxy_pass $vehicles_backend;

    proxy_set_header traceparent $http_traceparent;
    proxy_set_header tracestate $http_tracestate;
    proxy_set_header X-Request-ID $request_id_value;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_redirect off;
}

location ~ ^/vehicles/(swagger-ui\.html|swagger-ui/.*|v3/api-docs(?:/.*)?|webjars/.*)$ {
    limit_req zone=api_general burst=20 nodelay;

    include /etc/nginx/cors/cors-preflight-full.conf;
    include /etc/nginx/cors/cors-hide-upstream.conf;
    include /etc/nginx/cors/cors-response-full.conf;
    include /etc/nginx/security-headers.conf;

    set $vehicles_backend "http://vehicles-api:8880";
    proxy_pass $vehicles_backend;

    proxy_set_header traceparent $http_traceparent;
    proxy_set_header tracestate $http_tracestate;
    proxy_set_header X-Request-ID $request_id_value;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_redirect off;
}

location /vehicles {
    limit_req zone=api_general burst=20 nodelay;
    auth_request /_auth/cloudapp/header-or-cookie;
    error_page 401 = @cors_unauthorized;

    include /etc/nginx/cors/cors-preflight-full.conf;
    include /etc/nginx/cors/cors-hide-upstream.conf;
    include /etc/nginx/cors/cors-response-full.conf;
    include /etc/nginx/security-headers.conf;

    set $vehicles_backend "http://vehicles-api:8880";
    proxy_pass $vehicles_backend;

    proxy_set_header traceparent $http_traceparent;
    proxy_set_header tracestate $http_tracestate;
    proxy_set_header X-Request-ID $request_id_value;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_redirect off;
}

# =====================================================================
# Jira Proxy Routes
# =====================================================================
location /jiraproxy {
    limit_req zone=api_general burst=10 nodelay;
    auth_request /_auth/cloudapp/header-or-cookie;
    error_page 401 = @cors_unauthorized;

    include /etc/nginx/cors/cors-preflight-full.conf;
    include /etc/nginx/cors/cors-hide-upstream.conf;
    include /etc/nginx/cors/cors-response-full.conf;
    include /etc/nginx/security-headers.conf;

    set $jira_backend "http://jiraproxy:8501";
    proxy_pass $jira_backend;

    proxy_set_header traceparent $http_traceparent;
    proxy_set_header tracestate $http_tracestate;
    proxy_set_header X-Request-ID $request_id_value;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_redirect off;
}

# =====================================================================
# ML Ops Routes
# =====================================================================
location = /mlops-segmentation/health {
    limit_req zone=api_general burst=5 nodelay;

    include /etc/nginx/cors/cors-hide-upstream.conf;
    include /etc/nginx/cors/cors-response-health.conf;
    include /etc/nginx/security-headers.conf;

    set $mlops_backend "http://mlops-segmentation:8600";
    proxy_pass $mlops_backend;

    proxy_set_header traceparent $http_traceparent;
    proxy_set_header tracestate $http_tracestate;
    proxy_set_header X-Request-ID $request_id_value;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_redirect off;
}

location /mlops-segmentation {
    limit_req zone=api_general burst=10 nodelay;
    auth_request /_auth/cloudapp/header-or-cookie;
    error_page 401 = @cors_unauthorized;

    include /etc/nginx/cors/cors-preflight-full.conf;
    include /etc/nginx/cors/cors-hide-upstream.conf;
    include /etc/nginx/cors/cors-response-full.conf;
    include /etc/nginx/security-headers.conf;

    set $mlops_backend "http://mlops-segmentation:8600";
    proxy_pass $mlops_backend;

    proxy_set_header traceparent $http_traceparent;
    proxy_set_header tracestate $http_tracestate;
    proxy_set_header X-Request-ID $request_id_value;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_redirect off;
}
